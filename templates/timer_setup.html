{% extends "layout.html" %}

{% block title%}
    Timer setup
{% endblock %}

{% block body %}
    <div id="timer-body">
        <div class="timer-firstdiv" id="firstDiv">
            <p class="tset_text">Number of timers: </p>
            <input class="tset_num_timers" autocomplete="off" id="numTimers" maxlength="2" min=1 name="num_timers" placeholder ="1" type="text">
            <p class="tset_text">All continuous?: </p>
            <input autocomplete="off" id="continuous" name="continuous" type="checkbox">
        </div>
        <div id="timer-load-buttons">
            <button id="btnSetup" type="button">Setup</button>
            <button id="btnLoadData" type="button">Load Timer</button>
            <div class="timer-dropdown">
                <div id="user-selection" class="timer-user-dropdown">
                </div>
            </div>
        </div>
    </div>
    <div id="buttons">
        <button style=display:none id="btnStart" type="button">Start</button>
        <button style=display:none id="btnStop" type="button">Stop</button>
        <button style=display:none id="btnNext" type="button">Next</button>
        <button style=display:none id="btnReset" type="button">Reset</button>
        <button style=display:none id="btnSave" type="button">Save Timer</button>
        <button style="display:none" id="btnBack" type="button">Back</button>
    </div>
    <div id="secondDiv" class="timerSecondDiv">
        <table>
            <tbody id="userTimers">
            </tbody>
        </table>
    </div>
    <div id="bottom-buttons">
        <button id="btnLoad" type="button">Load</button>
        <p style="display:none" id="loop-text">Loop timers: </p>
        <input style="display:none" id="loop-check" type="checkbox">
    </div>
    <div id="bottom-text">
    </div>
    

    <script>
        const btnSetup = document.getElementById("btnSetup");  // Load page button with number of timers    
        const btnLoad = document.getElementById("btnLoad"); // Load number of timers to array
        const btnStart = document.getElementById("btnStart"); // Start timer
        const btnStop = document.getElementById("btnStop"); // Stop timer
        const btnReset = document.getElementById("btnReset"); // Reset current timer
        const btnNext = document.getElementById("btnNext"); // Pass to next timer
        const btnSave = document.getElementById("btnSave"); // Save timer
        const btnLoadData = document.getElementById("btnLoadData"); // Select timers loaded from memory
        const btnBack = document.getElementById("btnBack"); // Go back to timer setup
        let timerOn = false; // True only when timer is running
        let pauseTimer = false // For btnStart. If true timer is running. Toggles button function.
        let saveTimers = {}; // Save the content of the timers
        let contTimers = false; // true if all continuous is checked
        let fistStart = true; 
        let nTimers = 0; // Saves the ammount of timers
        let timerPass = 0; // In which timer the clock is currently. Used of loop function
        let ceroTimer = false; // Checks when the timer is at 00:00
        let timerFinish = false; // To check when the active timer is finished. Works with checkboxes
        let delTimers = nTimers; // For nextTimer function. FIX TEXT Keeps track of the number of the last element in the timers
        let numbNextTimers = 1; // For nextTimer function. Number of the timer that follows the active timer 
        let numCheck; // Keeps track of the status of the next check(continuous)
        let saveBtnFtn = false; // For saveButton. False creates save input. True saves content in input
        let userTimerSelect; // Save the name of the timer selected by user. Gets result from function dropdownSelect
        let loadSkip = false; // When using dropdownSelect skips obtaining data from btnLoad
        let loopTimers = false // Loops through timers if True
        let backTimer = false // for btnBack. When back is pressed turns off timer and returns relevant variables to neutral position
        let arrayUndo = []; // Stores temporally local data for use of undo button when timer is deleted from memory
        let loadStatus = false // For dropDownSelect. True when timer is loaded from local memory.
        let timerNames = []; 

        window.onload = function(){ 
            for (i = 0; i < localStorage.length ; i++) {
                timerNames.push(localStorage.key(i));
            }
            let menuHTML = "";
            if (timerNames.length > 0) {
                for (i = 0; i < timerNames.length; i++) {
                    let idName = JSON.parse(localStorage.getItem(timerNames[i]));
                    menuHTML += `<div id="drop-div${idName.id}" style="display:inline-block"><button id="select${idName.id}"` +
                    `onclick="dropdownSelect('${timerNames[i]}')"type="button">${timerNames[i]}<button id="${idName.id}"` + 
                    `onclick="dropdownDelete('${timerNames[i]}','${idName.id}')">Delete</button></div>`;
                }
            } else {
                menuHTML += "<p>No timers saved</p>";
            }
            document.getElementById("user-selection").innerHTML += menuHTML;
            addAlert("Welcome to Study Sessions");
        };

        // Set the ammount of timers so they can be manually set up
        btnSetup.addEventListener("click", function(e) {
            document.getElementById("loop-text").style.display ="inline";
            document.getElementById("loop-check").style.display ="inline";
            nTimers = Number(document.getElementById("numTimers").value);
            if (isNaN(nTimers) == true) {
                addAlert("Input error: Use a numeric value in input");
                highlight(document.getElementById("numTimers"));
                document.getElementById("numTimers").value = "";
                return;
            }
            if (nTimers <= 0) {
                addAlert("Input Error: Number of timers must be bigger than 0");
                document.getElementById("numTimers").value = "";
                return;

            } else {
                delTimers = nTimers;
                var HTML = "<table><tr><th>Minutes</th><th>Seconds</th><th>Continuous</th></tr>";
                for (let i = 0; i < nTimers; i++) {
                    HTML += `<tr></td><td><input autocomplete="off" id="timerMin${i}" min="0" max="60" maxlength="2" ` +
                    `placeholder="00" type="text"> :</td><td><input autocomplete="off" id="timerSec${i}" min="0" max="60"` + 
                    `maxlength="2" placeholder="00" type="text"></td><td><input id="set-check${i}" type="checkbox"></td></tr>`;
                };
                HTML += "</table>";
                document.getElementById("userTimers").innerHTML = HTML;
            }

        });

        // Load the numbers of the timers in an array
        btnLoad.addEventListener("click", function(e) {
            timerLoad();
        }); 
        
        btnStart.addEventListener("click", function(e) {
            if (pauseTimer = false) {
                pauseTimer = true;
            } else {
                pauseTimer = false;
            }
            backTimer = false;
            if (ceroTimer == false && timerOn == false) {
                downTimer();
            }
        });

        btnReset.addEventListener("click", function(e) {
            document.getElementById("timerMin").innerHTML = padZero(saveTimers["min" + (numbNextTimers - 1)]);
            document.getElementById("timerSec").innerHTML = padZero(saveTimers["sec" + (numbNextTimers - 1)]);
            document.getElementById("btnStop").click()
        });

        btnNext.addEventListener("click", function(e) {
            if (numbNextTimers != nTimers) {
                nextTimer();
            };
        });

        // Save data locally 
        btnSave.addEventListener("click", function(e) {
            if (saveBtnFtn == false) {
                let intHTML = "<input id='timer-name' type='text'>";
                    document.getElementById("secondDiv").innerHTML += intHTML;
                    saveBtnFtn = true;
            } else {
                let saveName = document.getElementById("timer-name").value;
                saveTimers.length = nTimers;
                saveTimers.id = localStorage.length + 1;
                localStorage.setItem(saveName, JSON.stringify(saveTimers));
                saveBtnFtn = false;
                addAlert("Timer saved!");
                document.getElementById("timer-name").remove();
                for (i = 0; i < localStorage.length ; i++) {
                    timerNames.push(localStorage.key(i));
                }
                let menuHTML = `<div id="drop-div${saveTimers.id}" style="display:inline-block"><button id="select${saveTimers.id}"` + 
                `onclick="dropdownSelect('${saveName}')"type="button">${saveName}<button id="${timerNames.length}"` +
                `onclick="dropdownDelete('${saveName}','${saveTimers.id}')">Delete</button></div>`;
                document.getElementById("user-selection").innerHTML += menuHTML;
                delete saveTimers.length;
                delete saveTimers.id;
            };
        });  

        btnLoadData.addEventListener("click", function(e) {
            myFunction();
        });

        btnBack.addEventListener("click", function(e) {
            backTimer = true;
            let setupHTML = '<p class="tset_text">Number of timers: </p>' +
            '<input class="tset_num_timers" autocomplete="off" id="numTimers" min=0 name="num_timers" placeholder="1" type="text">' +
            '<p class="tset_text">All continuous?: </p><input autocomplete="off" id="continuous" name="continuous" type="checkbox">';
            document.getElementById("btnStart").style.display = "none"; 
            document.getElementById("btnStop").style.display = "none"; 
            document.getElementById("btnNext").style.display = "none"; 
            document.getElementById("btnReset").style.display = "none"; 
            document.getElementById("btnSave").style.display = "none"; 
            document.getElementById("btnBack").style.display = "none";
            document.getElementById("bottom-buttons").style.display = "inline-block";
            document.getElementById("firstDiv").innerHTML = setupHTML;
            let secondSetup = '<table><tbody id="userTimers"></tbody></table>';
            document.getElementById("secondDiv").innerHTML = secondSetup;
            loadSkip = true;
            ceroTimer = false;
            numbNextTimers = 1;
            delTimers = nTimers;
            document.getElementById("btnSetup").style.display = "inline";
            document.getElementById("btnLoadData").style.display = "inline";
            loadStatus = false;
        })

        //FUNCTIONS     
        function addAlert(text) {
            let textbox = document.getElementById("bottom-text");
            let textHTML = "<p>· ";
            textHTML += text;
            textHTML += "</p>";
            textbox.innerHTML += textHTML;
            textbox.scrollTop = textbox.scrollHeight;
        }

        function addAlertUndo(text, name) {
            let textbox = document.getElementById("bottom-text");
            let textHTML = `<p>· ` + name;
            textHTML += ` ${text}<button id="undo-button" onclick="undoTimer('${name}')" ` +
            `style="border: none;text-decoration: underline; display: inline-block;">`;
            textHTML += `undo</button></p>` ;
            textbox.innerHTML += textHTML;
            textbox.scrollTop = textbox.scrollHeight;
        }

        function downTimer () { // Timer mechanism
            timerFinish = false;
            timerOn = true; 
            let timerStart = setInterval(() => {
                sec = Number(document.getElementById("timerSec").innerHTML);
                min = Number(document.getElementById("timerMin").innerHTML);
                sec = sec - 1;
                if (sec == -1) {
                    sec = 59;
                    min = min - 1;
                    if (min == -1) {
                        min = 59;
                    };
                };
                document.getElementById("timerSec").innerHTML = padZero(sec);
                document.getElementById("timerMin").innerHTML = padZero(min);
                btnStop.addEventListener("click", function(e) {
                    timerOn = false;
                    clearInterval(timerStart);
                });
                btnBack.onclick = function() {
                    timerOn = false;
                    clearInterval(timerStart);
                }
                
                if (backTimer == true || pauseTimer == true) {
                    timerPass += 1;
                    clearInterval(timerStart);
                }

                if (min == 0 && sec == 0) {
                    play();
                    timerPass += 1;
                    timerOn = false;
                    timerFinish = true;
                    ceroTimer = true; 
                    clearInterval(timerStart);
                    addAlert("Timer finished");
                    let check0 = document.getElementById("check0");
                    if (check0.checked == true && numbNextTimers != nTimers) {
                        nextTimer();
                        downTimer();
                    };
                    if (loopTimers == true && timerPass == nTimers) {
                        loadSkip = true;
                        ceroTimer = false;
                        numbNextTimers = 1;
                        delTimers = nTimers;
                        timerPass = 0;
                        renderTimers();
                    }
                };
            }, 1000);
        } 

        function dropdownSelect(name) {
            if (loadStatus == false) {
                saveTimers = JSON.parse(localStorage.getItem(name));
                nTimers = saveTimers.length;
                delTimers = nTimers;
                delete saveTimers.length;
                loadSkip = true;
                myFunction()
                timerLoad();
                loadStatus = true;
            }
        }

        function dropdownDelete(name, number) {
            addAlertUndo("Timer deleted", name);
            console.log(name);
            let tempData = JSON.parse(localStorage.getItem(name));
            sessionStorage.setItem(name, JSON.stringify(tempData));
            localStorage.removeItem(name);
            let foo = document.getElementById(number);
            foo.remove();
            document.getElementById("select" + number).remove();
            document.getElementById("drop-div" + number).remove();
            arrayUndo[name] = tempData;
            let tempKeys = Object.keys(arrayUndo);
            btnUndo = document.getElementById("undo-button");
        }

        function highlight(obj) {
            orig = obj.style.borderColor;
            obj.style.borderColor = "red";
            setTimeout(() => {
                obj.style.borderColor = orig;
            }, (4000));
        }

        function myFunction() {
                document.getElementById("user-selection").classList.toggle("show");
            }

        function nextTimer() {   // Pass to next timer     
            let timerReplaceMin = document.getElementById("timerMin");
            let timerReplaceSec = document.getElementById("timerSec");
            timerReplaceMin.innerHTML = padZero(saveTimers[`min${numbNextTimers}`]);
            timerReplaceSec.innerHTML = padZero(saveTimers[`sec${numbNextTimers}`]);
            document.getElementById("check0").checked = document.getElementById("check1").checked;
            for (i = 1; i < delTimers - 1; i++) {
                document.getElementById("min" + i).innerHTML = padZero(saveTimers[`min${numbNextTimers + i}`]);
                document.getElementById("sec" + i).innerHTML = padZero(saveTimers[`sec${numbNextTimers + i}`]);
                document.getElementById("check" + i).checked = document.getElementById(`check${i + 1}`).checked;
            }
            delTimers -= 1;
            timerFinish = false;
            numbNextTimers += 1;
            let x = document.getElementById(`nextTimers${delTimers}`);
            x.remove();
            ceroTimer = false;
        };

        function padZero(num) { // Leading zero
            return String(num).padStart(2, '0');
        }

        function play() {
            let bell = new Audio("./static/bell1.mp3");
            bell.play();
        }
        
        function renderTimers() {
            var firstHTML ='<div class="timerFirstDiv"><p id="timerMin">' +
            padZero(saveTimers["min0"]) + '</p><p>:</p><p id="timerSec">'+ 
            padZero(saveTimers["sec0"]) + '</p>'
            if (contTimers == true || saveTimers["check0"] == true) {
                firstHTML += '<input class="timerCheck" id="check0" type="checkbox" checked></div>';
            } 
            else {
                firstHTML += '<input class="timerCheck" id="check0" type="checkbox"></div>';
            }
            var nextHTML = '';
            for (let i = 1; i < nTimers; i++) {
                nextHTML += '<div id="nextTimers' + i + '">';
                nextHTML += '<p id="min' + i + '">' + padZero(saveTimers[`min${i}`]) + '</p>' +
                '<p>:</p><p id="sec' + i + '">' + padZero(saveTimers[`sec${i}`]) + '</p>' 
                if (contTimers == true || saveTimers[`check${i}`] == true) {
                    nextHTML += '<input class="timerCheck" id="check' + i + '" type="checkbox" checked><br>'
                }
                else {  
                    nextHTML += '<input class="timerCheck" id="check' + i + '" type="checkbox"><br>'
                }
                nextHTML += '</div>';
            };
            document.getElementById("firstDiv").innerHTML = firstHTML;
            document.getElementById("secondDiv").innerHTML = nextHTML;
            if (loopTimers == true) {
                downTimer();
            }
        }

        function timerLoad() {
            let errorLoad = false // true if any error in the following for loop is found
            if (loadSkip == false) {
                for(let i = 0; i < nTimers; i++) {
                    const testMin = document.getElementById(`timerMin${(i)}`).value;
                    const testSec = document.getElementById(`timerSec${(i)}`).value;
                    if (isNaN(testMin) == true) {
                        addAlert(`Input error in Minute ${i + 1}: Use a numeric value in minutes`);
                        document.getElementById(`timerMin${i + 1}`).value = "";
                        highlight(document.getElementById(`timerMin${(i + 1)}`));
                        errorLoad = true;
                    }
                    if (isNaN(testSec) == true) {
                        addAlert(`Input error in Second ${i + 1 }: Use a numeric value in seconds`);
                        document.getElementById(`timerSec${i + 1}`).value = "";
                        highlight(document.getElementById(`timerSec${(i + 1)}`));
                        errorLoad = true;
                    }
                    if (testMin < 0) {
                        addAlert(`Input error in Minute ${i + 1}: Value must be a positive number`);
                        document.getElementById(`timerMin${i + 1}`).value = "";
                        highlight(document.getElementById(`timerMin${(i + 1)}`));
                        errorLoad = true;
                    }
                    if (testSec < 0) {
                        addAlert(`Input Error in Second ${i + 1}: Seconds must be a positive number`);
                        document.getElementById(`timerSec${i + 1}`).value = "";
                        highlight(document.getElementById(`timerSec${(i + 1)}`));
                        errorLoad = true;
                    }
                    const textCheck = document.getElementById(`set-check${i}`).checked;
                    saveTimers["min" + i] = Number(testMin);
                    saveTimers["sec" + i] = Number(testSec);
                    saveTimers["check" + i] = textCheck;
                     if (document.getElementById("continuous").checked == true) {
                        contTimers = true;
                    }
                };
                if (errorLoad == true){
                        errorLoad = false;
                        return;
                    }
            }

            if(document.getElementById("loop-check").checked == true) {
                loopTimers = true;
                addAlert("Timer Loop: On");
            }
            renderTimers();
            document.getElementById("btnStart").style.display = "inline"; // Start timer
            document.getElementById("btnStop").style.display = "inline"; // Stop timer
            document.getElementById("btnNext").style.display = "inline"; // Pass to next timer
            document.getElementById("btnReset").style.display = "inline"; // Reset current timer
            document.getElementById("btnSave").style.display = "inline"; // Save timer
            document.getElementById("btnBack").style.display = "inline"; // Go back to setup
            document.getElementById("btnSetup").style.display = "none";
            document.getElementById("btnLoadData").style.display = "none";
            document.getElementById("bottom-buttons").style.display = "none";
        }

        function undoTimer(name) {
            localStorage.setItem(name, JSON.stringify(arrayUndo[name]))
            addAlert("timer restored");
            sessionStorage.removeItem(name);
            let menuHTML = `<div id="drop-div${arrayUndo[name].id}"style="display:inline-block">` +
            `<button id="select${arrayUndo[name].id}" onclick="dropdownSelect('${name}')"type="button">${name}`+
            `<button id="${arrayUndo[name].id}" onclick="dropdownDelete('${name}','${arrayUndo[name].id}')">Delete</button></div>`;
            document.getElementById("user-selection").innerHTML += menuHTML;
            delete arrayUndo[name];
        }
    </script>

{% endblock %}
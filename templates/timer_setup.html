{% extends "layout.html" %}

{% block title%}
    Timer setup
{% endblock %}

{% block body %}
    <div id="timer-body">
        <div class="timer-firstdiv" id="firstDiv">
            <p class="tset_text">Number of timers: </p>
            <input class="tset_num_timers" autocomplete="off" id="numTimers" min=0 name="num_timers" type="text">
            <p class="tset_text">All continuous?: </p>
            <input autocomplete="off" id="continuous" name="continuous" type="checkbox">
        </div>
        <div id="timer-load-buttons">
            <button id="btnSetup" type="button">Setup</button>
            <button id="btnLoadData" type="button">Load Timer</button>
            <div class="timer-dropdown">
                <div id="user-selection" class="timer-user-dropdown">
                </div>
            </div>
        </div>
    </div>
    <div id="buttons">
        <button style=display:none id="btnStart" type="button">Start</button>
        <button style=display:none id="btnStop" type="button">Stop</button>
        <button style=display:none id="btnNext" type="button">Next</button>
        <button style=display:none id="btnSave" type="button">Save Timer</button>
        <button style="display:none" id="btnBack" type="button">Back</button>
    </div>
    <div id="secondDiv" class="timerSecondDiv">
        <table>
            <tbody id="userTimers">
            </tbody>
        </table>
        <div class="bottom-buttons">
            <button id="btnLoad" type="button">Load</button>
            <p style="display:none" id="loop-text">Loop timers: </p>
            <input style="display:none" id="loop-check" type="checkbox">
        </div>
    </div>
    

    <script>
        const btnSetup = document.getElementById("btnSetup");  // Load page button with number of timers    
        const btnLoad = document.getElementById("btnLoad"); // Load number of timers to array
        const btnStart = document.getElementById("btnStart"); // Start timer
        const btnStop = document.getElementById("btnStop"); // Stop timer
        const btnNext = document.getElementById("btnNext"); // Pass to next timer
        const btnSave = document.getElementById("btnSave"); // Save timer
        const btnLoadData = document.getElementById("btnLoadData"); // Select timers loaded from memory
        const btnBack = document.getElementById("btnBack"); // Go back to timer setup
        let timerOn = false; // True only when timer is running
        let saveTimers = {}; // Save the number of timers
        let contTimers = false; // true if all continuous timer is checked
        let fistStart = true; 
        let nTimers; // Saves the ammount of timers
        let ceroTimer = false; // Checks when the timer is at 00:00
        let timerFinish = false; // To check when the active timer is finished. Works with checkboxes
        let delTimers = nTimers; // For nextTimer function. Keeps track of the number of the last element in the timers
        let numbNextTimers = 1; // For nextTimer function. Number of the timer that follows the active timer 
        let numCheck; // Keeps track of the status of the next check(continuous)
        let saveBtnFtn = false; // For saveButton. False creates save input. True saves content in input
        let userTimerSelect; // Save the name of the timer selected by user. Gets result from function dropdownSelect
        let loadSkip = false; // When using dropdownSelect skips obtaining data from btnLoad
        let loopTimers = false // Loops through timers if True
        let backTimer = false // for btnBack. When back is pressed turns off timer and returns relevant variables to neutral position

        window.onload = function(){ 
            for (i = 0; i < localStorage.length ; i++) {
                timerNames.push(localStorage.key(i));
            }
            let menuHTML = "";
            if (timerNames.length > 0) {
                for (i = 0; i < timerNames.length; i++) {
                    menuHTML += "<p id='select' onclick='dropdownSelect()'>" + timerNames[i] + "</p>";
                }
            } else {
                menuHTML += "<p>No timers saved</p>";
            }
            document.getElementById("user-selection").innerHTML += menuHTML;
        };

        // Set the ammount of timers so they can be manually set up
        btnSetup.addEventListener("click", function(e) {
            document.getElementById("loop-text").style.display ="inline";
            document.getElementById("loop-check").style.display ="inline";
            nTimers = Number(document.getElementById("numTimers").value);
            delTimers = nTimers;
            var HTML = "<table><tr><th>NÃºmero</th><th>Timer</th><th>Continuous</th></tr>";
                for (let i = 0; i < nTimers; i++) {
                    HTML += "<tr><td>" + (i + 1) + "</td><td><input autocomplete='off' id='timerMin" + (i + 1) + 
                    "' min='0' max='60' maxlength='2' type='text'></td><td>:</td>" + 
                    "<td><input autocomplete='off' id='timerSec" + (i + 1) + 
                    "' min='0' max='60' maxlength='2' type='text'>" + "</td><td><input id='set-check" + (i + 1) + 
                    "'type='checkbox'></td></tr>";
                };
            HTML += "</table>";
             document.getElementById("userTimers").innerHTML = HTML;
        });

        // Load the numbers of the timers in an array
        btnLoad.addEventListener("click", function(e) {
            if (loadSkip == false) {
                for(let i = 0; i < nTimers; i++) {
                    const testMin = document.getElementById(`timerMin${(i + 1)}`).value;
                    const testSec = document.getElementById(`timerSec${(i + 1)}`).value;
                    const textCheck = document.getElementById(`set-check${i + 1}`).checked;
                    saveTimers["min" + i] = Number(testMin);
                    saveTimers["sec" + i] = Number(testSec);
                    saveTimers["check" + i] = textCheck;
                     if (document.getElementById("continuous").checked == true) {
                        contTimers = true;
                    }
                };
            }

            if(document.getElementById("loop-check").checked == true) {
                loopTimers = true;
            }
            renderTimers();
            document.getElementById("btnStart").style.display = "inline"; // Start timer
            document.getElementById("btnStop").style.display = "inline"; // Stop timer
            document.getElementById("btnNext").style.display = "inline"; // Pass to next timer
            document.getElementById("btnSave").style.display = "inline"; // Save timer
            document.getElementById("btnBack").style.display = "inline"; // Go back to setup
            document.getElementById("btnSetup").style.display = "none";
            document.getElementById("btnLoadData").style.display = "none";
        }); 
        
        btnStart.addEventListener("click", function(e) {
            backTimer = false;
            if (ceroTimer == false && timerOn == false) {
                downTimer();
            }
        });

        btnNext.addEventListener("click", function(e) {
            if (numbNextTimers != nTimers) {
                nextTimer();
            };
        });

        // Save data locally 
        btnSave.addEventListener("click", function(e) {
            if (saveBtnFtn == false) {
                let intHTML = "<input id='timer-name' type='text'>";
                    document.getElementById("secondDiv").innerHTML += intHTML;
                    saveBtnFtn = true;
            } else {
                let saveName = document.getElementById("timer-name").value;
                saveTimers.length = nTimers;
                localStorage.setItem(saveName, JSON.stringify(saveTimers));
                delete saveTimers.length;
                saveBtnFtn = false;
                alert("Timer saved");
            };
        });  

        let timerNames = []; // VARIABLE MOVE TO TOP
        btnLoadData.addEventListener("click", function(e) {
            myFunction();
        });

        btnBack.addEventListener("click", function(e) {
            backTimer = true;
            let setupHTML = '<p class="tset_text">Number of timers: </p>' +
            '<input class="tset_num_timers" autocomplete="off" id="numTimers" min=0 name="num_timers" type="text">' +
            '<p class="tset_text">All continuous?: </p><input autocomplete="off" id="continuous" name="continuous" type="checkbox">' +
            '<button id="btnSetup" type="button">Setup</button><button id="btnLoadData" type="button">Load Timer</button>' +
            '<div class="timer-dropdown"><div id="user-selection" class="timer-user-dropdown"></div>';
            document.getElementById("btnStart").style.display = "none"; // Start timer
            document.getElementById("btnStop").style.display = "none"; // Stop timer
            document.getElementById("btnNext").style.display = "none"; // Pass to next timer
            document.getElementById("btnSave").style.display = "none"; // Save timer
            document.getElementById("btnBack").style.display = "none"; // Go back to setup
            document.getElementById("firstDiv").innerHTML = setupHTML;
            let secondSetup = '<table><tbody id="userTimers"></tbody></table><div class="bottom-buttons">' +
            '<button id="btnLoad" type="button">Load</button><p style="display:none" id="loop-text">Loop timers: </p>' +
            '<input style="display:none" id="loop-check" type="checkbox"></div>';
            document.getElementById("secondDiv").innerHTML = secondSetup;
            loadSkip = true;
            ceroTimer = false;
            numbNextTimers = 1;
            delTimers = nTimers;
            document.getElementById("btnSetup").style.display = "inline";
            document.getElementById("btnLoadData").style.display = "inline"
        })

        //FUNCTIONS 

        function myFunction() {
                document.getElementById("user-selection").classList.toggle("show");
            }

        function downTimer () { // Timer mechanism
            timerFinish = false;
            timerOn = true; 
            let timerStart = setInterval(() => {
                sec = Number(document.getElementById("timerSec").innerHTML);
                min = Number(document.getElementById("timerMin").innerHTML);
                sec = sec - 1;
                if (sec == -1) {
                    sec = 59;
                    min = min - 1;
                    if (min == -1) {
                        min = 59;
                    };
                };
                document.getElementById("timerSec").innerHTML = padZero(sec);
                document.getElementById("timerMin").innerHTML = padZero(min);
                btnStop.addEventListener("click", function(e) {
                    timerOn = false;
                    clearInterval(timerStart);
                });
                
                if (backTimer == true) {
                    clearInterval(timerStart);
                }

                if (min == 0 && sec == 0) {
                    play();
                    timerOn = false;
                    timerFinish = true;
                    ceroTimer = true; 
                    clearInterval(timerStart);
                    let check0 = document.getElementById("check0");
                    if (check0.checked == true && numbNextTimers != nTimers) {
                        nextTimer();
                        downTimer();
                    };
                    if (loopTimers == true) {
                        loadSkip = true;
                        ceroTimer = false;
                        numbNextTimers = 1;
                        delTimers = nTimers;
                        renderTimers();
                    }
                };
            }, 1000);
        } 

        function nextTimer() {   // Pass to next timer     
            let timerReplaceMin = document.getElementById("timerMin");
            let timerReplaceSec = document.getElementById("timerSec");
            timerReplaceMin.innerHTML = padZero(saveTimers[`min${numbNextTimers}`]);
            timerReplaceSec.innerHTML = padZero(saveTimers[`sec${numbNextTimers}`]);
            document.getElementById("check0").checked = document.getElementById("check1").checked;
            for (i = 1; i < delTimers - 1; i++) {
                document.getElementById("min" + i).innerHTML = padZero(saveTimers[`min${numbNextTimers + i}`]);
                document.getElementById("sec" + i).innerHTML = padZero(saveTimers[`sec${numbNextTimers + i}`]);
                document.getElementById("check" + i).checked = document.getElementById(`check${i + 1}`).checked;
            }
            delTimers = delTimers - 1;
            timerFinish = false;
            numbNextTimers = numbNextTimers + 1;
            let x = document.getElementById(`nextTimers${delTimers}`);
            x.remove();
            ceroTimer = false;
            };

        function padZero(num) { // Leading zero
            return String(num).padStart(2, '0');
        }

        function play() {
            let bell = new Audio("./static/bell1.mp3");
            bell.play();
        }

        function dropdownSelect(e) {
            window.onclick = e => {
                saveTimers = JSON.parse(localStorage.getItem(e.target.innerHTML));
                nTimers = saveTimers.length;
                delete saveTimers.length;
                loadSkip = true;
                document.getElementById("btnLoad").click();
            }
        }

        function renderTimers() {
            var firstHTML ='<div class="timerFirstDiv"><p id="timerMin">' +
            padZero(saveTimers["min0"]) + '</p><p>:</p><p id="timerSec">'+ 
            padZero(saveTimers["sec0"]) + '</p>'
            if (contTimers == true || saveTimers["check0"] == true) {
                firstHTML += '<input class="timerCheck" id="check0" type="checkbox" checked></div>';
            } 
            else {
                firstHTML += '<input class="timerCheck" id="check0" type="checkbox"></div>';
            }
            var nextHTML = '';
            for (let i = 1; i < nTimers; i++) {
                nextHTML += '<div id="nextTimers' + i + '">';
                nextHTML += '<p id="min' + i + '">' + padZero(saveTimers[`min${i}`]) + '</p>' +
                '<p>:</p><p id="sec' + i + '">' + padZero(saveTimers[`sec${i}`]) + '</p>' 
                if (contTimers == true || saveTimers[`check${i}`] == true) {
                    nextHTML += '<input class="timerCheck" id="check' + i + '" type="checkbox" checked><br>'
                }
                else {  
                    nextHTML += '<input class="timerCheck" id="check' + i + '" type="checkbox"><br>'
                }
                nextHTML += '</div>';
            };
            document.getElementById("firstDiv").innerHTML = firstHTML;
            document.getElementById("secondDiv").innerHTML = nextHTML;
        }
    </script>

{% endblock %}